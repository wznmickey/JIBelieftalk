<!DOCTYPE html>
<meta charset="UTF-8">

<!--left part-->
<div id="leftpart" style="position: fixed; width: 29%;max-width: 29%;font-size:24px;text-size-adjust: none;">
    <div>
        <input id="inputCertainUser"></input>
        <button id="connectCertainUser" onclick="connect()">连接</button>
    </div>
    <div id="contacter">
        <ul class="list" style="list-style-type: none;padding-inline-start: 0%;">
        </ul>
    </div>
    <button type="button" id="log_out" onclick="logout()" style="background-color: rgba(255, 255, 255, .2);"
        class="inputB">登出</button>
</div>

<!--right part-->
<div id="rightpart" style="margin-left:30%;text-align: center;font-size:24px;text-size-adjust: none;">
    <div id="toppart"
        style="position: fixed;left: 65%;white-space: normal;word-wrap: break-word;word-break: break-all;height: 10%;transform: translateX(-50%);width: fit-content;max-width: 60%;">
        <button onclick="switchleftpart()">侧栏</button>
        <text>我的Id:</text><text id="myId">登录中</text>
        <text>连接的对话者:</text><text id="partId">暂无</text>
    </div>
    <text id="received" style="top:11%;white-space:normal;word-wrap:break-word;word-break:break-all"></text>
    <div id="bottompart" style="position:fixed;top:90%;left:65%;transform: translateX(-50%);">
        <input id="message"></input>
        <button id="sendmessage" onclick="send()">发送</button>
        <button id="getHistory" type="button" onclick="getHistory()">获取历史记录</button>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.10.1/dist/av-min.js"></script>
<script src="//cdn.jsdelivr.net/npm/leancloud-realtime@5.0.0-rc.5/dist/im-browser.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/leancloud-realtime-plugin-typed-messages@3.1.0/dist/typed-messages.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
<script>
    var messageIterator;
    const { Realtime, TextMessage, TypedMessagesPlugin, ImageMessage } = AV;
    const realtime = new Realtime({
        appId: '65ITQv1gCBeVOfaB5lY2YsxE-9Nh9j0Va',
        appKey: '5Jg7aEOsyhVt3JLESAH55H8o',
        server: 'https://api.belief.wznmickey.com',
        plugins: [TypedMessagesPlugin],
    });
    AV.init({
        appId: "65ITQv1gCBeVOfaB5lY2YsxE-9Nh9j0Va",
        appKey: "5Jg7aEOsyhVt3JLESAH55H8o",
        serverURL: "https://api.belief.wznmickey.com"
    });
    const currentUser = AV.User.current();
    var iMClient;
    var conversation;
    function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }

    function getHistory() {
        messageIterator.next().then(function (result) {
            var messages = result.value;
            var temp = "";
            for (var i = 0; i < messages.length; i++) {
                temp = temp + "<p>" + messages[i].from + ":" + messages[i].text;
            }
            document.getElementById("received").innerHTML = temp + document.getElementById("received").innerHTML;
            $('html,body').animate({ scrollTop: "100000px" }, 100);
        }).catch(console.error.bind(console));
        $('html,body').animate({ scrollTop: "100000px" }, 100);
    }
    function setContacterlist(iMClient) {
        var contacterquery = iMClient.getQuery();
        contacterquery.find().then(function (conversations) {
            console.log(conversations);
            var options = {
                valueNames: ['Id'],
                item: '<li><button class="Id" style="width: 100%;white-space:normal;word-break: break-all;" onclick="setcontacter(this)"></button></li>'
            };
            var values = [];
            for (var i = 0; i < conversations.length; i++) {
                var j;
                for (j = 0; j < conversations[i].members.length; j++) {
                    if (conversations[i].members[j] != iMClient.id) break;
                }
                var nicknamequery = new AV.Query('User_nickname');
                var tempvalue;
                (function (i, j) {
                    const nicknametempfind = new AV.Query('User_nickname');
                    nicknametempfind.equalTo('UserId', conversations[i].members[j]);
                    sleep(20).then(() => {
                        nicknametempfind.find().then((tempuser) => {
                            console.log(tempuser);
                            console.log(tempuser.length);
                            if (tempuser.length >= 1) {
                                console.log(tempuser[0].attributes.nickname);
                                tempvalue = { Id: tempuser[0].attributes.nickname};
                            }
                            else {
                                tempvalue = { Id: conversations[i].members[j] };
                            }
                            values[i] = tempvalue;
                            console.log(tempvalue);
                            var list = new List('contacter', options, values);
                            list.clear();
                            List('contacter', options, values);
                        });
                    });
                })(i, j);
            }

        }).catch(console.error.bind(console));
    }
    function switchleftpart() {
        if (document.getElementById("leftpart").hidden == false) {
            document.getElementById("leftpart").hidden = true;
            document.getElementById("rightpart").style = "text-align:center;font-size:24px;text-size-adjust: none;";
            document.getElementById("toppart").style = "position: fixed;left: 50%;white-space: normal;word-wrap: break-word;word-break: break-all;height: 10%;transform: translateX(-50%);width: fit-content;max-width: 60%;";
            document.getElementById("bottompart").style = "position:fixed;top:90%;left:50%;transform: translateX(-50%);";
        }
        else {
            document.getElementById("leftpart").hidden = false;
            document.getElementById("rightpart").style = "margin-left:30%; text-align:center;font-size:24px;text-size-adjust: none;";
            document.getElementById("toppart").style = "position: fixed;left: 65%;white-space: normal;word-wrap: break-word;word-break: break-all;height: 10%;transform: translateX(-50%);width: fit-content;max-width: 60%;";
            document.getElementById("bottompart").style = "position:fixed;top:90%;left:65%;transform: translateX(-50%);";

        }
    }
    function setcontacter(event) {
        document.getElementById("inputCertainUser").value = event.innerHTML;
        connect();
    }
    realtime.createIMClient(currentUser).then(function (user) {
        iMClient = user;
        console.log(iMClient);
        document.getElementById("myId").innerHTML = iMClient.id;
        setContacterlist(iMClient);

        iMClient.on('invited', function invitedEventHandler(payload, conversation) {
            console.log(payload.invitedBy, conversation.id);
            setContacterlist(iMClient);
        });

        user.on('message', function (message, conversation) {
            console.log('收到新消息：' + message.text);
            document.getElementById("received").innerHTML = document.getElementById("received").innerHTML + "<p>" + message.from + ":" + message.text;
        });

    });
    if (!currentUser) {
        window.location.href = "index.html";
    }
    function logout() {
        AV.User.logOut();
        iMClient.close().then(function () {
            console.log('退出登录');
        }).catch(console.error.bind(console));
        window.location.href = "index.html";
    }
    function connect() {
        iMClient.createConversation({
            members: [document.getElementById("inputCertainUser").value],
            name: 'testconversation',
            unique: true
        }).then(function (con) {
            conversation = con;
            document.getElementById("partId").innerHTML = document.getElementById("inputCertainUser").value;
            setContacterlist(iMClient);
            document.getElementById("received").innerHTML = "";
            messageIterator = con.createMessagesIterator({ limit: 20 });
            messageIterator.next().then(function (result) {
                var messages = result.value;
                for (var i = 0; i < messages.length; i++) {
                    document.getElementById("received").innerHTML = document.getElementById("received").innerHTML + "<p>" + messages[i].from + ":" + messages[i].text;
                }
            }).catch(console.error.bind(console));
            document.getElementById("inputCertainUser").value = "";
        });
    }
    function send() {
        conversation.send(new TextMessage(document.getElementById("message").value)).then(function (message) {
            console.log('发送成功！');
            document.getElementById("received").innerHTML = document.getElementById("received").innerHTML + "<p>" + iMClient.id + ":" + document.getElementById("message").value;

        }).catch(console.error);

    }
    function sendonline() {
        const message = new TextMessage('OFFLINEofflineOFFLINE_willMessage');
        conversation.send(message, { will: true });
    }
</script>